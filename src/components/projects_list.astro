---
import { Image } from "astro:assets";
import { CollectionEntry, getCollection } from "astro:content";
import FormattedDate from "./formatted_date.astro";

export type Project = CollectionEntry<"projects">;

export type Props = {
	minimal?: boolean;
	featured?: boolean;
	filter?: (item: Project) => unknown;
	prioritize?: boolean;
	maximum?: number;
};

let {
	minimal = false,
	featured = false,
	filter,
	prioritize = false,
	maximum,
} = Astro.props;

if (featured) {
	filter ??= (project: Project) => project.data.feature;
}

let projects: Project[] = (await getCollection("projects", filter)).sort(
	({ data: a }, { data: b }) => {
		if (!a.endDate && !b.endDate) {
			return 0;
		} else if (!b.endDate) {
			return 1;
		} else if (!a.endDate) {
			return -1;
		}
		return (
			(b.startDate as unknown as number) -
			(a.startDate as unknown as number)
		);
	}
);

if (prioritize) {
	projects.sort(({ data: a }, { data: b }) => {
		if (!a.priority && b.priority) {
			return -1;
		}
		if (a.priority && !b.priority) {
			return 1;
		}
		if (!a.priority && !b.priority) {
			return 0;
		}
		if (a.priority! < b.priority!) {
			return -1;
		}
		if (a.priority! > b.priority!) {
			return 1;
		}
		return 0;
	});
}

if (maximum) {
	projects = projects.slice(0, Math.min(maximum, projects.length));
}
---

<div
	aria-role="list"
	class:list={["projects-list", featured && "featured", minimal && "minimal"]}
>
	{
		projects.map((project) => {
			const Tag = project.data.link ? "a" : "article";
			return (
				// FIXME: Make it more clear whether a project is a link or not
				<Tag class="project-item" href={project.data.link || "#"}>
					{featured && project.data.screenshot && (
						<div
							class="project-media"
							style={{
								"--width": project.data.screenshot.width,
								"--height": project.data.screenshot.height,
							}}
						>
							<div class="media-container">
								<Image
									src={project.data.screenshot}
									alt={
										project.data.screenshotAlt ||
										`${project.data.title}'s screenshot'`
									}
								/>
							</div>
						</div>
					)}
					<div class="project-content">
						<div class="project-info">
							<h3 class="project-title">{project.data.title}</h3>
							<p class="project-headline">
								{project.data.headline}
							</p>
						</div>
						<div class="project-date">
							<FormattedDate
								date={project.data.startDate}
								hideDay
							/>{" "}
							-{" "}
							{project.data.endDate ? (
								<FormattedDate
									date={project.data.endDate}
									hideDay
								/>
							) : (
								"Present"
							)}
						</div>
					</div>
				</Tag>
			);
		})
	}
</div>

<style is:global>
	.projects-list {
		.project-item {
			color: inherit;
			text-decoration: none;
			display: block;
			border-radius: 0.5rem;

			.project-title {
				font-weight: 500;
			}

			.project-headline {
				color: var(--text-secondary);
			}

			.project-date {
				color: var(--text-tertiary);
			}
		}

		&.featured {
			.project-item {
				display: flex;
				align-items: center;
				margin-block-end: 3rem;

				.project-media {
					position: relative;
					flex: 1;
					width: 100%;
					margin-inline: 0 1rem;
					max-width: 100%;

					@supports not (aspect-ratio: 1) {
						.media-container {
							padding-bottom: calc(
								var(--height) / var(--width) * 100%
							);
						}
					}

					@supports (aspect-ratio: 1) {
						aspect-ratio: var(--width) / var(--height);
					}

					& img {
						position: absolute;
						inset: 0;
						width: 100%;
						height: 100%;
					}
				}

				.project-title {
					font-size: 1.25rem;
				}

				.project-content {
					flex: 1;
				}

				&:nth-child(even) {
					flex-direction: row-reverse;

					.project-media {
						margin-inline: 1rem 0;
					}
				}

				@media (width <= 768px) {
					display: block;

					.project-media {
						margin-inline: 0 !important;
						margin-block-end: 0.5rem;
					}
				}
			}
		}

		&.minimal {
			display: block;

			.project-item {
				padding: 0;
				margin-block-end: 2rem;

				.project-info {
					display: flex;
					align-items: center;

					@media (width <= 768px) {
						display: block;

						.project-media {
							margin-inline: 0 !important;
							margin-block-end: 0.5rem;
						}
					}
				}

				.project-title {
					margin-inline-end: 0.5rem;
					font-size: 1.05rem;
				}
			}
		}
	}
</style>
